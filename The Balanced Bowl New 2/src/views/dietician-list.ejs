<!doctype html>
<html>
  <%- include('partials/head') %>
<body>
  <div class="container">
    <%- include('partials/header') %>

    <!-- PAGE HEADER -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0;">Find a Dietician</h2>

      <!-- SEARCH BAR -->
      <form action="/dieticians" method="get" 
            style="display:flex; gap:8px; align-items:center;">
        <input 
          type="text" 
          name="q" 
          placeholder="Search dietician by name..." 
          value="<%= query.q || '' %>"
          style="padding:8px 12px; border:1px solid #dfe8df; border-radius:8px; width:220px;">
        <button class="btn">Search</button>
      </form>
    </div>

    <!-- LIST GRID -->
    <div class="grid" style="margin-top:12px;">
      <% dieticians.forEach(function(d){ %>
        
        <% 
          const uname = d.user ? d.user.name : "Unknown"; 
          const initials = uname.split(" ").map(n => n[0]).slice(0,2).join("");
          const specialization = (d.specialization && d.specialization.length) 
              ? d.specialization.join(", ") 
              : "—";
        %>

        <!-- DIETICIAN CARD -->
        <div class="card" 
             style="display:flex; gap:16px; align-items:center; padding:18px;">

          <!-- Avatar -->
          <div class="avatar"
               style="width:60px; height:60px; font-size:22px;">
            <%= initials %>
          </div>

          <!-- Info -->
          <div style="flex:1;">
            <h3 style="margin:0 0 6px 0;">
              <a href="/dieticians/<%= d._id %>" 
                 style="text-decoration:none; color:var(--text);">
                <%= uname %>
              </a>
            </h3>

            <div class="meta" style="line-height:1.5;">
              <strong>Specialization:</strong> <%= specialization %> <br>
              <strong>Experience:</strong> <%= d.experienceYears || 0 %> years <br>
              <strong>Fee:</strong> ₹<%= d.fee || 0 %>
            </div>
          </div>

          <!-- View Button -->
          <!-- Action Buttons -->
<div style="display:flex; flex-direction:column; gap:10px;">

  <!-- View Profile -->
  <a href="/dieticians/<%= d._id %>" 
     class="btn" 
     style="padding:8px 16px;">
     View
  </a>

  <!-- Book Button (Only for logged-in USERS) -->
  <% if (currentUser && currentUser.role === 'user') { %>
    <a href="/appointments/book/<%= d._id %>" 
       class="btn" 
       style="padding:8px 16px; background:var(--accent-600); color:white;">
       Book
    </a>
  <% } %>

  <!-- If NOT logged in → prompt login -->
  <% if (!currentUser) { %>
    <a href="/login" 
       class="btn" 
       style="padding:8px 16px;">
       Login to Book
    </a>
  <% } %>

</div>

        </div>

      <% }) %>

      <% if (dieticians.length === 0) { %>
        <div class="card" style="padding:24px; text-align:center;">
          No dieticians found — try searching with another name.
        </div>
      <% } %>
    </div>

    <%- include('partials/footer') %>
  </div>
</body>
</html>
